<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Universal Timeline Manager</title>
</head>
<body>
    <div id="timelineConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-textarea">
        <div data-role="content">
            <div class="content-primary">
                <form id="timelineConfigForm">
                    <h2>Universal Timeline Manager Configuration</h2>
                    
                    <div class="verticalSection">
                        <h3 class="sectionTitle">Timeline Configuration Editor</h3>
                        <p class="fieldDescription">
                            Edit your timeline configuration below. The configuration defines which movies and TV episodes belong to each cinematic universe in chronological order.
                        </p>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="jsonEditor">JSON Configuration:</label>
                            <textarea 
                                id="jsonEditor" 
                                class="emby-textarea"
                                rows="20"
                                style="font-family: 'Courier New', monospace; font-size: 0.9em; width: 100%; padding: 10px; box-sizing: border-box;">
                            </textarea>
                            <div class="fieldDescription">
                                Edit the JSON configuration above. Use Provider IDs (TMDB/IMDB) to identify your content.
                            </div>
                        </div>

                        <div id="messageContainer" style="margin-top: 1em; display: none;"></div>

                        <div class="verticalSection" style="margin-top: 1.5em;">
                            <button type="button" class="raised button-submit emby-button" id="validateBtn">
                                <span>Validate Configuration</span>
                            </button>
                            <button type="button" class="raised button-submit emby-button" id="saveBtn" style="margin-left: 0.5em;">
                                <span>Save Configuration</span>
                            </button>
                            <button type="button" class="raised emby-button" id="loadSampleBtn" style="margin-left: 0.5em;">
                                <span>Load Sample</span>
                            </button>
                        </div>
                    </div>

                    <div class="verticalSection">
                        <h3 class="sectionTitle">Configuration Format</h3>
                        <div class="fieldDescription">
                            <p><strong>Required Fields:</strong></p>
                            <ul>
                                <li><strong>key:</strong> Unique identifier for the universe (e.g., "mcu", "dceu")</li>
                                <li><strong>name:</strong> Display name (e.g., "Marvel Cinematic Universe")</li>
                                <li><strong>providerId:</strong> TMDB or IMDB ID for the content</li>
                                <li><strong>providerName:</strong> Either "tmdb" or "imdb"</li>
                                <li><strong>type:</strong> Either "movie" or "episode"</li>
                            </ul>
                        </div>
                    </div>

                    <div class="verticalSection">
                        <h3 class="sectionTitle">How to Find Provider IDs</h3>
                        <div class="fieldDescription">
                            <p><strong>TMDB IDs:</strong> Visit <a href="https://www.themoviedb.org" target="_blank" rel="noopener">themoviedb.org</a>, search for your content, and copy the ID from the URL</p>
                            <p><strong>IMDB IDs:</strong> Visit <a href="https://www.imdb.com" target="_blank" rel="noopener">imdb.com</a>, search for your content, and copy the ID (starts with "tt")</p>
                            <p><strong>From Jellyfin:</strong> Right-click content → Edit Metadata → External IDs tab</p>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        console.log('[Timeline] Script file loaded - IMMEDIATE');
        
        (() => {
            console.log('[Timeline] IIFE executing');
            
            var sampleConfig = {
                "universes": [
                    {
                        "key": "mcu",
                        "name": "Marvel Cinematic Universe",
                        "items": [
                            {
                                "providerId": "1771",
                                "providerName": "tmdb",
                                "type": "movie"
                            },
                            {
                                "providerId": "1399",
                                "providerName": "tmdb",
                                "type": "episode"
                            }
                        ]
                    }
                ]
            };

            function showMessage(message, isError) {
                console.log('[Timeline] Showing message:', message);
                var messageContainer = document.querySelector('#messageContainer');
                messageContainer.style.display = 'block';
                messageContainer.style.padding = '1em';
                messageContainer.style.borderRadius = '4px';
                messageContainer.style.marginTop = '1em';
                
                if (isError) {
                    messageContainer.style.background = 'rgba(255, 0, 0, 0.1)';
                    messageContainer.style.borderLeft = '4px solid #ff0000';
                    messageContainer.style.color = '#ff6b6b';
                } else {
                    messageContainer.style.background = 'rgba(0, 255, 0, 0.1)';
                    messageContainer.style.borderLeft = '4px solid #00ff00';
                    messageContainer.style.color = '#51cf66';
                }
                
                messageContainer.innerHTML = message;
            }

            function hideMessage() {
                document.querySelector('#messageContainer').style.display = 'none';
            }

            function loadConfiguration() {
                console.log('[Timeline] Loading configuration');
                window.ApiClient.ajax({
                    url: window.ApiClient.getUrl('timeline/config'),
                    type: 'GET',
                    dataType: 'json'
                }).then(function(config) {
                    console.log('[Timeline] Config loaded:', config);
                    var jsonEditor = document.querySelector('#jsonEditor');
                    if (config && config.universes && config.universes.length > 0) {
                        jsonEditor.value = JSON.stringify(config, null, 2);
                    } else {
                        jsonEditor.value = JSON.stringify(sampleConfig, null, 2);
                    }
                }).catch(function(error) {
                    console.error('[Timeline] Error loading configuration:', error);
                    document.querySelector('#jsonEditor').value = JSON.stringify(sampleConfig, null, 2);
                });
            }

            function validateConfiguration() {
                console.log('[Timeline] Validate clicked');
                hideMessage();
                
                var jsonEditor = document.querySelector('#jsonEditor');
                var jsonContent = jsonEditor.value.trim();
                
                if (!jsonContent) {
                    showMessage('Please enter a configuration to validate', true);
                    return;
                }

                try {
                    JSON.parse(jsonContent);
                } catch (e) {
                    console.error('[Timeline] JSON parse error:', e);
                    showMessage('<strong>JSON Syntax Error:</strong><br>' + e.message, true);
                    return;
                }

                console.log('[Timeline] Sending validation request');
                window.ApiClient.ajax({
                    url: window.ApiClient.getUrl('timeline/validate'),
                    type: 'POST',
                    data: JSON.stringify({ jsonContent: jsonContent }),
                    contentType: 'application/json',
                    dataType: 'json'
                }).then(function(result) {
                    console.log('[Timeline] Validation result:', result);
                    if (result.isValid) {
                        showMessage('<strong>✓ Configuration is valid!</strong><br>You can now save this configuration.', false);
                    } else {
                        var errorHtml = '<strong>Validation Errors:</strong><ul style="margin: 0.5em 0; padding-left: 1.5em;">';
                        result.errors.forEach(function(error) {
                            errorHtml += '<li>' + error + '</li>';
                        });
                        errorHtml += '</ul>';
                        showMessage(errorHtml, true);
                    }
                }).catch(function(error) {
                    console.error('[Timeline] Validation error:', error);
                    showMessage('<strong>Error:</strong> ' + error.message, true);
                });
            }

            function saveConfiguration() {
                console.log('[Timeline] Save clicked');
                hideMessage();
                
                var jsonEditor = document.querySelector('#jsonEditor');
                var jsonContent = jsonEditor.value.trim();
                
                if (!jsonContent) {
                    showMessage('Please enter a configuration to save', true);
                    return;
                }

                try {
                    JSON.parse(jsonContent);
                } catch (e) {
                    showMessage('<strong>JSON Syntax Error:</strong><br>' + e.message + '<br><br>Please fix the JSON syntax before saving.', true);
                    return;
                }

                console.log('[Timeline] Sending save request');
                window.ApiClient.ajax({
                    url: window.ApiClient.getUrl('timeline/save'),
                    type: 'POST',
                    data: JSON.stringify({ jsonContent: jsonContent }),
                    contentType: 'application/json',
                    dataType: 'json'
                }).then(function(result) {
                    console.log('[Timeline] Save result:', result);
                    if (result.success) {
                        showMessage('<strong>✓ Configuration saved successfully!</strong><br>Your timeline configuration has been saved.', false);
                    } else {
                        var errorHtml = '<strong>Save Failed:</strong><br>' + result.message;
                        if (result.errors && result.errors.length > 0) {
                            errorHtml += '<ul style="margin: 0.5em 0; padding-left: 1.5em;">';
                            result.errors.forEach(function(error) {
                                errorHtml += '<li>' + error + '</li>';
                            });
                            errorHtml += '</ul>';
                        }
                        showMessage(errorHtml, true);
                    }
                }).catch(function(error) {
                    console.error('[Timeline] Save error:', error);
                    showMessage('<strong>Error:</strong> ' + error.message, true);
                });
            }

            function loadSample() {
                console.log('[Timeline] Load sample clicked');
                document.querySelector('#jsonEditor').value = JSON.stringify(sampleConfig, null, 2);
                showMessage('Sample configuration loaded. Edit as needed and click Validate.', false);
            }

            document.querySelector('#timelineConfigPage').addEventListener('pageshow', function() {
                console.log('[Timeline] Page shown, initializing');
                
                loadConfiguration();
                
                document.querySelector('#validateBtn').addEventListener('click', function(e) {
                    e.preventDefault();
                    validateConfiguration();
                });
                
                document.querySelector('#saveBtn').addEventListener('click', function(e) {
                    e.preventDefault();
                    saveConfiguration();
                });
                
                document.querySelector('#loadSampleBtn').addEventListener('click', function(e) {
                    e.preventDefault();
                    loadSample();
                });
                
                console.log('[Timeline] Initialization complete');
            });
            
            // Fallback: also try DOMContentLoaded
            document.addEventListener('DOMContentLoaded', function() {
                console.log('[Timeline] DOMContentLoaded fired');
                var page = document.querySelector('#timelineConfigPage');
                if (page) {
                    console.log('[Timeline] Page element found, setting up listeners');
                    loadConfiguration();
                    
                    document.querySelector('#validateBtn').addEventListener('click', function(e) {
                        e.preventDefault();
                        validateConfiguration();
                    });
                    
                    document.querySelector('#saveBtn').addEventListener('click', function(e) {
                        e.preventDefault();
                        saveConfiguration();
                    });
                    
                    document.querySelector('#loadSampleBtn').addEventListener('click', function(e) {
                        e.preventDefault();
                        loadSample();
                    });
                }
            });
        })();
    </script>
</body>
</html>
