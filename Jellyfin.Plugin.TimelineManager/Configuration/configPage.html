<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Universal Timeline Manager</title>
    <style>
        #jsonEditor {
            font-family: 'Courier New', monospace !important;
            font-size: 0.9em !important;
            width: 100% !important;
            min-height: 400px !important;
            padding: 10px !important;
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>
    <div id="timelineConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-textarea">
        <div data-role="content">
            <div class="content-primary">
                <form id="timelineConfigForm">
                    <h2>Universal Timeline Manager Configuration</h2>
                    
                    <div class="verticalSection">
                        <h3 class="sectionTitle">Timeline Configuration Editor</h3>
                        <p class="fieldDescription">
                            Edit your timeline configuration below. The configuration defines which movies and TV episodes belong to each cinematic universe in chronological order.
                        </p>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="jsonEditor">JSON Configuration:</label>
                            <textarea 
                                id="jsonEditor" 
                                class="emby-textarea"
                                rows="20">
                            </textarea>
                            <div class="fieldDescription">
                                Edit the JSON configuration above. Use Provider IDs (TMDB/IMDB) to identify your content.
                            </div>
                        </div>

                        <div id="messageContainer" style="margin-top: 1em; display: none;"></div>

                        <div class="verticalSection" style="margin-top: 1.5em;">
                            <button type="button" class="raised button-submit emby-button" id="validateBtn">
                                <span>Validate Configuration</span>
                            </button>
                            <button type="button" class="raised button-submit emby-button" id="saveBtn" style="margin-left: 0.5em;">
                                <span>Save Configuration</span>
                            </button>
                            <button type="button" class="raised emby-button" id="loadSampleBtn" style="margin-left: 0.5em;">
                                <span>Load Sample</span>
                            </button>
                        </div>
                    </div>

                    <div class="verticalSection">
                        <h3 class="sectionTitle">Configuration Format</h3>
                        <div class="fieldDescription">
                            <p><strong>Required Fields:</strong></p>
                            <ul>
                                <li><strong>key:</strong> Unique identifier for the universe (e.g., "mcu", "dceu")</li>
                                <li><strong>name:</strong> Display name (e.g., "Marvel Cinematic Universe")</li>
                                <li><strong>providerId:</strong> TMDB or IMDB ID for the content</li>
                                <li><strong>providerName:</strong> Either "tmdb" or "imdb"</li>
                                <li><strong>type:</strong> Either "movie" or "episode"</li>
                            </ul>
                        </div>
                    </div>

                    <div class="verticalSection">
                        <h3 class="sectionTitle">How to Find Provider IDs</h3>
                        <div class="fieldDescription">
                            <p><strong>TMDB IDs:</strong> Visit <a href="https://www.themoviedb.org" target="_blank" rel="noopener">themoviedb.org</a>, search for your content, and copy the ID from the URL</p>
                            <p><strong>IMDB IDs:</strong> Visit <a href="https://www.imdb.com" target="_blank" rel="noopener">imdb.com</a>, search for your content, and copy the ID (starts with "tt")</p>
                            <p><strong>From Jellyfin:</strong> Right-click content → Edit Metadata → External IDs tab</p>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        (function() {
            console.log('Timeline Config Page Script Loading...');
            
            const page = document.querySelector('#timelineConfigPage');
            const jsonEditor = document.querySelector('#jsonEditor');
            const validateBtn = document.querySelector('#validateBtn');
            const saveBtn = document.querySelector('#saveBtn');
            const loadSampleBtn = document.querySelector('#loadSampleBtn');
            const messageContainer = document.querySelector('#messageContainer');

            console.log('Elements found:', {
                page: !!page,
                jsonEditor: !!jsonEditor,
                validateBtn: !!validateBtn,
                saveBtn: !!saveBtn,
                loadSampleBtn: !!loadSampleBtn,
                messageContainer: !!messageContainer
            });

            const sampleConfig = {
                "universes": [
                    {
                        "key": "mcu",
                        "name": "Marvel Cinematic Universe",
                        "items": [
                            {
                                "providerId": "1771",
                                "providerName": "tmdb",
                                "type": "movie"
                            },
                            {
                                "providerId": "1399",
                                "providerName": "tmdb",
                                "type": "episode"
                            }
                        ]
                    }
                ]
            };

            function showMessage(message, isError) {
                console.log('Showing message:', message, 'isError:', isError);
                messageContainer.style.display = 'block';
                messageContainer.style.padding = '1em';
                messageContainer.style.borderRadius = '4px';
                messageContainer.style.marginTop = '1em';
                
                if (isError) {
                    messageContainer.style.background = 'rgba(255, 0, 0, 0.1)';
                    messageContainer.style.borderLeft = '4px solid #ff0000';
                    messageContainer.style.color = '#ff6b6b';
                } else {
                    messageContainer.style.background = 'rgba(0, 255, 0, 0.1)';
                    messageContainer.style.borderLeft = '4px solid #00ff00';
                    messageContainer.style.color = '#51cf66';
                }
                
                messageContainer.innerHTML = message;
            }

            function hideMessage() {
                messageContainer.style.display = 'none';
            }

            async function loadConfiguration() {
                console.log('Loading configuration...');
                try {
                    const response = await fetch('/api/timeline/config');
                    console.log('Config response status:', response.status);
                    const config = await response.json();
                    console.log('Config loaded:', config);
                    
                    if (config && config.universes && config.universes.length > 0) {
                        jsonEditor.value = JSON.stringify(config, null, 2);
                    } else {
                        jsonEditor.value = JSON.stringify(sampleConfig, null, 2);
                    }
                } catch (error) {
                    console.error('Error loading configuration:', error);
                    jsonEditor.value = JSON.stringify(sampleConfig, null, 2);
                }
            }

            async function validateConfiguration() {
                console.log('Validate button clicked');
                hideMessage();
                
                try {
                    const jsonContent = jsonEditor.value.trim();
                    console.log('JSON content length:', jsonContent.length);
                    
                    if (!jsonContent) {
                        showMessage('Please enter a configuration to validate', true);
                        return;
                    }

                    // Test JSON parsing first
                    try {
                        JSON.parse(jsonContent);
                    } catch (e) {
                        console.error('JSON parse error:', e);
                        showMessage('<strong>JSON Syntax Error:</strong><br>' + e.message, true);
                        return;
                    }

                    console.log('Sending validation request...');
                    const response = await fetch('/api/timeline/validate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ jsonContent: jsonContent })
                    });

                    console.log('Validation response status:', response.status);
                    const result = await response.json();
                    console.log('Validation result:', result);
                    
                    if (result.isValid) {
                        showMessage('<strong>✓ Configuration is valid!</strong><br>You can now save this configuration.', false);
                    } else {
                        let errorHtml = '<strong>Validation Errors:</strong><ul style="margin: 0.5em 0; padding-left: 1.5em;">';
                        result.errors.forEach(function(error) {
                            errorHtml += '<li>' + error + '</li>';
                        });
                        errorHtml += '</ul>';
                        showMessage(errorHtml, true);
                    }
                } catch (error) {
                    console.error('Validation error:', error);
                    showMessage('<strong>Error:</strong> ' + error.message, true);
                }
            }

            async function saveConfiguration() {
                console.log('Save button clicked');
                hideMessage();
                
                try {
                    const jsonContent = jsonEditor.value.trim();
                    
                    if (!jsonContent) {
                        showMessage('Please enter a configuration to save', true);
                        return;
                    }

                    // Test JSON parsing first
                    try {
                        JSON.parse(jsonContent);
                    } catch (e) {
                        showMessage('<strong>JSON Syntax Error:</strong><br>' + e.message + '<br><br>Please fix the JSON syntax before saving.', true);
                        return;
                    }

                    console.log('Sending save request...');
                    const response = await fetch('/api/timeline/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ jsonContent: jsonContent })
                    });

                    console.log('Save response status:', response.status);
                    const result = await response.json();
                    console.log('Save result:', result);
                    
                    if (result.success) {
                        showMessage('<strong>✓ Configuration saved successfully!</strong><br>Your timeline configuration has been saved.', false);
                    } else {
                        let errorHtml = '<strong>Save Failed:</strong><br>' + result.message;
                        if (result.errors && result.errors.length > 0) {
                            errorHtml += '<ul style="margin: 0.5em 0; padding-left: 1.5em;">';
                            result.errors.forEach(function(error) {
                                errorHtml += '<li>' + error + '</li>';
                            });
                            errorHtml += '</ul>';
                        }
                        showMessage(errorHtml, true);
                    }
                } catch (error) {
                    console.error('Save error:', error);
                    showMessage('<strong>Error:</strong> ' + error.message, true);
                }
            }

            function loadSample() {
                console.log('Load sample button clicked');
                jsonEditor.value = JSON.stringify(sampleConfig, null, 2);
                showMessage('Sample configuration loaded. Edit as needed and click Validate.', false);
            }

            // Event listeners
            if (validateBtn) {
                validateBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    validateConfiguration();
                });
                console.log('Validate button listener attached');
            }

            if (saveBtn) {
                saveBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    saveConfiguration();
                });
                console.log('Save button listener attached');
            }

            if (loadSampleBtn) {
                loadSampleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    loadSample();
                });
                console.log('Load sample button listener attached');
            }

            // Load configuration when page loads
            if (page) {
                page.addEventListener('pageshow', function() {
                    console.log('Page shown, loading configuration');
                    loadConfiguration();
                });
            }

            // Also try loading immediately
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                console.log('Document ready, loading configuration immediately');
                setTimeout(loadConfiguration, 100);
            }

            console.log('Timeline Config Page Script Loaded');
        })();
    </script>
</body>
</html>