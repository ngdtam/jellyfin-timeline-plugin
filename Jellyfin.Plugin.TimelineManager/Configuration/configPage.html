<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Timeline Manager</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .sidebar {
            width: 350px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
            max-height: 80vh;
        }

        .content-area {
            flex: 1;
            padding: 20px;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .media-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: grab;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }

        .media-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .media-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .media-item img {
            width: 40px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 12px;
            background: #f0f0f0;
        }

        .media-info {
            flex: 1;
        }

        .media-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .media-details {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }

        .provider-ids {
            font-size: 11px;
            color: #888;
            font-family: monospace;
        }

        .universe-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .universe-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .universe-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .universe-controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .timeline-items {
            min-height: 100px;
            padding: 20px;
            border: 2px dashed #e9ecef;
            border-radius: 6px;
            margin: 15px;
        }

        .timeline-items.drag-over {
            border-color: #667eea;
            background-color: #f8f9ff;
        }

        .timeline-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .timeline-item-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .timeline-item img {
            width: 30px;
            height: 45px;
            object-fit: cover;
            border-radius: 3px;
            margin-right: 10px;
        }

        .remove-item {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-item:hover {
            background: #c82333;
        }

        .add-universe {
            text-align: center;
            padding: 40px;
        }

        .universe-form {
            display: none;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .actions {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .drag-placeholder {
            background: #e3f2fd;
            border: 2px dashed #2196f3;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            color: #1976d2;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Universal Timeline Manager</h1>
            <p>Create chronological playlists by dragging movies and TV episodes into your universes</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <input type="text" class="search-box" id="searchBox" placeholder="Search movies and TV shows...">
                <div id="mediaList" class="loading">
                    Loading your media library...
                </div>
            </div>

            <div class="content-area">
                <div class="universe-form" id="universeForm">
                    <div class="form-group">
                        <label for="universeKey">Universe Key (no spaces):</label>
                        <input type="text" id="universeKey" placeholder="e.g., mcu, dceu, star-wars">
                    </div>
                    <div class="form-group">
                        <label for="universeName">Universe Name:</label>
                        <input type="text" id="universeName" placeholder="e.g., Marvel Cinematic Universe">
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-success" onclick="createUniverse()">Create Universe</button>
                        <button class="btn" onclick="cancelUniverse()">Cancel</button>
                    </div>
                </div>

                <div id="universesList">
                    <div class="add-universe">
                        <button class="btn btn-primary" onclick="showUniverseForm()">+ Add New Universe</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-success" onclick="saveConfiguration()">Save Configuration</button>
            <button class="btn btn-primary" onclick="runTimeline()">Run Timeline Task</button>
        </div>
    </div>

    <script>
        let mediaItems = [];
        let universes = [];
        let draggedItem = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadMediaLibrary();
            loadConfiguration();
        });

        // Load media library from API
        async function loadMediaLibrary() {
            try {
                const response = await fetch('/Plugins/TimelineManager/library');
                if (!response.ok) throw new Error('Failed to load library');
                
                mediaItems = await response.json();
                renderMediaList();
            } catch (error) {
                console.error('Error loading media library:', error);
                document.getElementById('mediaList').innerHTML = 
                    '<div class="empty-state"><h3>Error</h3><p>Failed to load media library</p></div>';
            }
        }

        // Load existing configuration
        async function loadConfiguration() {
            try {
                const response = await fetch('/Plugins/TimelineManager/configuration');
                if (!response.ok) throw new Error('Failed to load configuration');
                
                const config = await response.json();
                universes = config.universes || [];
                renderUniverses();
            } catch (error) {
                console.error('Error loading configuration:', error);
                universes = [];
                renderUniverses();
            }
        }

        // Render media list in sidebar
        function renderMediaList(filteredItems = null) {
            const items = filteredItems || mediaItems;
            const mediaList = document.getElementById('mediaList');

            if (items.length === 0) {
                mediaList.innerHTML = '<div class="empty-state"><h3>No Media Found</h3><p>No movies or TV shows with Provider IDs found in your library</p></div>';
                return;
            }

            mediaList.innerHTML = items.map(item => `
                <div class="media-item" draggable="true" data-item='${JSON.stringify(item)}'>
                    ${item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.name}" onerror="this.style.display='none'">` : '<div style="width:40px;height:60px;background:#f0f0f0;border-radius:4px;margin-right:12px;"></div>'}
                    <div class="media-info">
                        <div class="media-title">${item.name}</div>
                        <div class="media-details">${item.type === 'movie' ? 'Movie' : 'TV Episode'} ${item.year ? `(${item.year})` : ''}</div>
                        <div class="provider-ids">
                            ${item.tmdbId ? `TMDB: ${item.tmdbId}` : ''}
                            ${item.tmdbId && item.imdbId ? ' | ' : ''}
                            ${item.imdbId ? `IMDB: ${item.imdbId}` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            // Add drag event listeners
            document.querySelectorAll('.media-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        // Search functionality
        document.getElementById('searchBox').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const filtered = mediaItems.filter(item => 
                item.name.toLowerCase().includes(query) ||
                (item.seriesName && item.seriesName.toLowerCase().includes(query))
            );
            renderMediaList(filtered);
        });

        // Render universes
        function renderUniverses() {
            const universesList = document.getElementById('universesList');
            
            if (universes.length === 0) {
                universesList.innerHTML = `
                    <div class="add-universe">
                        <h3>No Universes Created</h3>
                        <p>Create your first cinematic universe to get started</p>
                        <button class="btn btn-primary" onclick="showUniverseForm()">+ Add New Universe</button>
                    </div>
                `;
                return;
            }

            universesList.innerHTML = universes.map((universe, index) => `
                <div class="universe-section">
                    <div class="universe-header">
                        <div class="universe-title">${universe.name}</div>
                        <div class="universe-controls">
                            <button class="btn btn-danger" onclick="removeUniverse(${index})">Delete</button>
                        </div>
                    </div>
                    <div class="timeline-items" data-universe="${index}" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        ${universe.items && universe.items.length > 0 ? 
                            universe.items.map((item, itemIndex) => {
                                const mediaItem = findMediaItem(item.providerId, item.providerName);
                                return `
                                    <div class="timeline-item">
                                        <div class="timeline-item-info">
                                            ${mediaItem && mediaItem.imageUrl ? `<img src="${mediaItem.imageUrl}" alt="${mediaItem.name}">` : ''}
                                            <div>
                                                <div class="media-title">${mediaItem ? mediaItem.name : 'Unknown Item'}</div>
                                                <div class="media-details">${item.providerName.toUpperCase()}: ${item.providerId} (${item.type})</div>
                                            </div>
                                        </div>
                                        <button class="remove-item" onclick="removeTimelineItem(${index}, ${itemIndex})">Remove</button>
                                    </div>
                                `;
                            }).join('') : 
                            '<div class="drag-placeholder">Drag movies and TV episodes here to create your timeline</div>'
                        }
                    </div>
                </div>
            `).join('') + `
                <div class="add-universe">
                    <button class="btn btn-primary" onclick="showUniverseForm()">+ Add Another Universe</button>
                </div>
            `;
        }

        // Find media item by provider ID
        function findMediaItem(providerId, providerName) {
            return mediaItems.find(item => 
                (providerName === 'tmdb' && item.tmdbId === providerId) ||
                (providerName === 'imdb' && item.imdbId === providerId)
            );
        }

        // Drag and drop handlers
        function handleDragStart(e) {
            draggedItem = JSON.parse(e.target.dataset.item);
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedItem = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            if (!draggedItem) return;

            const universeIndex = parseInt(e.currentTarget.dataset.universe);
            const universe = universes[universeIndex];

            // Determine provider ID to use (prefer TMDB, fallback to IMDB)
            const providerId = draggedItem.tmdbId || draggedItem.imdbId;
            const providerName = draggedItem.tmdbId ? 'tmdb' : 'imdb';

            // Check if item already exists in this universe
            const exists = universe.items.some(item => 
                item.providerId === providerId && item.providerName === providerName
            );

            if (exists) {
                alert('This item is already in the timeline!');
                return;
            }

            // Add item to universe
            universe.items.push({
                providerId: providerId,
                providerName: providerName,
                type: draggedItem.type
            });

            renderUniverses();
        }

        // Universe management
        function showUniverseForm() {
            document.getElementById('universeForm').style.display = 'block';
            document.getElementById('universeKey').focus();
        }

        function cancelUniverse() {
            document.getElementById('universeForm').style.display = 'none';
            document.getElementById('universeKey').value = '';
            document.getElementById('universeName').value = '';
        }

        function createUniverse() {
            const key = document.getElementById('universeKey').value.trim();
            const name = document.getElementById('universeName').value.trim();

            if (!key || !name) {
                alert('Please fill in both universe key and name');
                return;
            }

            // Check for duplicate keys
            if (universes.some(u => u.key === key)) {
                alert('A universe with this key already exists');
                return;
            }

            universes.push({
                key: key,
                name: name,
                items: []
            });

            cancelUniverse();
            renderUniverses();
        }

        function removeUniverse(index) {
            if (confirm('Are you sure you want to delete this universe?')) {
                universes.splice(index, 1);
                renderUniverses();
            }
        }

        function removeTimelineItem(universeIndex, itemIndex) {
            universes[universeIndex].items.splice(itemIndex, 1);
            renderUniverses();
        }

        // Save configuration
        async function saveConfiguration() {
            try {
                const config = { universes: universes };
                const response = await fetch('/Plugins/TimelineManager/configuration', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (!response.ok) throw new Error('Failed to save configuration');

                alert('Configuration saved successfully!');
            } catch (error) {
                console.error('Error saving configuration:', error);
                alert('Failed to save configuration: ' + error.message);
            }
        }

        // Run timeline task
        async function runTimeline() {
            try {
                const response = await fetch('/Plugins/TimelineManager/run', {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('Failed to run timeline task');

                alert('Timeline task started! Check your playlists in a few moments.');
            } catch (error) {
                console.error('Error running timeline task:', error);
                alert('Failed to run timeline task: ' + error.message);
            }
        }
    </script>
</body>
</html>